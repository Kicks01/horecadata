<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Horeca Ø§Ù„Ø´Ø§Ù…Ù„ - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
            color: #fafafa;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #fafafa;
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 10px;
        }

        .header p {
            color: #a1a1aa;
            font-size: 1.1rem;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .stat-card h3 {
            color: #a1a1aa;
            font-size: 0.85rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stat-card .value {
            color: #fafafa;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .segment-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .segment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .segment-header h2 {
            color: #fafafa;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .customers-table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .customers-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            overflow: hidden;
        }

        .customers-table thead {
            background: rgba(255, 255, 255, 0.1);
        }

        .customers-table th {
            padding: 15px;
            text-align: right;
            color: #fafafa;
            font-weight: 700;
            font-size: 0.9rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .customers-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #e4e4e7;
            font-size: 0.9rem;
        }

        .customers-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ù„Ø¨ÙŠØ§Ù†Ø§Øª Horeca</h1>
            <p>ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙˆØ§Ù„Ù…Ø¯Ù†</p>
        </div>

        <div class="stats-overview">
            <div class="stat-card">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                <div class="value" id="totalCustomers">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (GMV)</h3>
                <div class="value" id="totalGMV">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
                <div class="value" id="totalOrders">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©</h3>
                <div class="value" id="uniqueProducts">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</h3>
                <div class="value" id="uniqueBrands">0</div>
            </div>
        </div>

        <div class="stats-overview">
            <div class="stat-card">
                <h3>Ù…ØªÙˆØ³Ø· GMV Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„</h3>
                <div class="value" id="avgGMV">0</div>
            </div>
            <div class="stat-card">
                <h3>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„</h3>
                <div class="value" id="avgOrders">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ù…Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)</h3>
                <div class="value" id="totalItems">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</h3>
                <div class="value" id="totalAreas">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ù†</h3>
                <div class="value" id="totalCities">0</div>
            </div>
        </div>
<div class="segment-section">
            <div class="segment-header">
                <h2>ğŸ“ˆ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ</h2>
            </div>
            <div id="segmentDistribution" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
            </div>
        </div>
        <div class="segment-section">
            <div class="segment-header">
                <h2>ğŸ™ï¸ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</h2>
            </div>
            <div class="customers-table-container">
                <table class="customers-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ GMV</th>
                            <th>Ù…ØªÙˆØ³Ø· GMV</th>
                            <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                        </tr>
                    </thead>
                    <tbody id="citiesTableBody">
                    </tbody>
                </table>
            </div>
            <div id="citiesPaginationContainer" style="display: flex; justify-content: center; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);"></div>
        </div>

        <div class="segment-section">
            <div class="segment-header">
                <h2>ğŸ“ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</h2>
            </div>
            <div class="customers-table-container">
                <table class="customers-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ GMV</th>
                            <th>Ù…ØªÙˆØ³Ø· GMV</th>
                            <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                        </tr>
                    </thead>
                    <tbody id="areasTableBody">
                    </tbody>
                </table>
            </div>
            <div id="areasPaginationContainer" style="display: flex; justify-content: center; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);"></div>
        </div>

        <div class="segment-section">
            <div class="segment-header">
                <h2>ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
            </div>
            <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                <input type="text" class="search-input" id="customerSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„..." style="flex: 1; min-width: 250px; padding: 12px 20px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fafafa; font-size: 0.9rem; font-family: 'Cairo', sans-serif;">
            </div>
            <div class="customers-table-container">
                <table class="customers-table" id="customersTable">
                    <thead>
                        <tr>
                            <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                            <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ GMV</th>
                            <th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
                            <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                        </tr>
                    </thead>
                    <tbody id="customersTableBody">
                    </tbody>
                </table>
            </div>
            <div id="paginationContainer" style="display: flex; justify-content: center; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);"></div>
        </div>
    </div>

    <script>
        // ========== DATA VARIABLES ==========
        let customersData = [];
        let groupedByArea = {};
        let groupedByCity = {};
        let segments = {};
        let filteredData = [];
        let currentPage = 1;
        let currentCityPage = 1;
        let currentAreaPage = 1;
        const itemsPerPage = 20;
        const citiesPerPage = 15;
        const areasPerPage = 15;

        // ========== INITIALIZATION ==========
        async function loadData() {
            try {
                // Determine the base path - works for both local server and Netlify
                const basePath = window.location.href.includes('localhost') || window.location.href.includes('127.0.0.1') 
                    ? window.location.origin 
                    : window.location.origin;
                
                // Try multiple paths for the data file (optimized for Netlify and local servers)
                const paths = [
                    '/dashboard_data.json',           // Root path (Netlify friendly)
                    './dashboard_data.json',          // Relative path
                    'dashboard_data.json',            // Relative without ./
                    basePath + '/dashboard_data.json' // Absolute path
                ];
                
                let data = null;
                let lastError = null;

                for (const path of paths) {
                    try {
                        const response = await fetch(path, {
                            method: 'GET',
                            headers: { 'Accept': 'application/json' }
                        });
                        
                        if (!response.ok) {
                            lastError = `HTTP ${response.status}: ${response.statusText}`;
                            continue;
                        }
                        
                        const text = await response.text();
                        
                        // Check if we actually got JSON
                        if (text.trim().startsWith('{') || text.trim().startsWith('[')) {
                            data = JSON.parse(text);
                            console.log('âœ“ Successfully loaded data from:', path);
                            break;
                        } else {
                            lastError = 'Response is not valid JSON (received HTML or text)';
                        }
                    } catch (error) {
                        lastError = error.message;
                        continue;
                    }
                }

                if (data && data.customers && Array.isArray(data.customers)) {
                    window.customersData = data.customers;
                    console.log('âœ“ Data loaded successfully with', data.customers.length, 'customers');
                    return true;
                } else {
                    console.error('âœ— Failed to load or parse data:', lastError);
                    return false;
                }
            } catch (error) {
                console.error('âœ— Error loading data:', error);
            }
            return false;
        }

        async function initialize() {
            const loaded = await loadData();
            if (loaded && window.customersData && window.customersData.length > 0) {
                initializeData();
                updateStatistics();
                renderAll();
                console.log('Dashboard initialized with', customersData.length, 'customers');
            } else {
                console.error('Failed to initialize dashboard');
            }
        }

        function initializeData() {
            customersData = [];
            
            // Load customers from the fetched data
            if (window.customersData && Array.isArray(window.customersData)) {
                customersData = window.customersData.map(customer => {
                    // Ensure segment color exists
                    if (!customer.segment_color) {
                        const colorMap = {
                            'Premium': '#4ade80',
                            'Standard': '#fbbf24',
                            'Low': '#f87171'
                        };
                        customer.segment_color = colorMap[customer.segment] || '#a1a1aa';
                    }
                    return customer;
                });
            }
            
            console.log('Total customers loaded:', customersData.length);

            // Group by area
            customersData.forEach(customer => {
                if (!groupedByArea[customer.area]) {
                    groupedByArea[customer.area] = {
                        area: customer.area,
                        customers: [],
                        total_gmv: 0,
                        customer_count: 0
                    };
                }
                groupedByArea[customer.area].customers.push(customer);
                groupedByArea[customer.area].total_gmv += customer.total_gmv;
                groupedByArea[customer.area].customer_count++;
            });

            // Group by city
            customersData.forEach(customer => {
                if (!groupedByCity[customer.city]) {
                    groupedByCity[customer.city] = {
                        city: customer.city,
                        customers: [],
                        total_gmv: 0,
                        customer_count: 0
                    };
                }
                groupedByCity[customer.city].customers.push(customer);
                groupedByCity[customer.city].total_gmv += customer.total_gmv;
                groupedByCity[customer.city].customer_count++;
            });

            // Group by segment
            customersData.forEach(customer => {
                if (!segments[customer.segment]) {
                    segments[customer.segment] = {
                        name: customer.segment,
                        count: 0,
                        gmv: 0,
                        color: customer.segment_color
                    };
                }
                segments[customer.segment].count++;
                segments[customer.segment].gmv += customer.total_gmv;
            });

            filteredData = [...customersData];
        }

        function updateStatistics() {
            const totalCustomers = customersData.length;
            const totalGMV = customersData.reduce((sum, c) => sum + c.total_gmv, 0);
            const totalOrders = customersData.reduce((sum, c) => sum + c.unique_orders, 0);
            const totalItems = customersData.reduce((sum, c) => sum + c.item_count, 0);

            const allProducts = new Set();
            const allBrands = new Set();

            customersData.forEach(customer => {
                Object.keys(customer.products || {}).forEach(p => allProducts.add(p));
                Object.keys(customer.brands || {}).forEach(b => allBrands.add(b));
            });

            document.getElementById('totalCustomers').textContent = totalCustomers.toLocaleString('ar');
            document.getElementById('totalGMV').textContent = totalGMV.toLocaleString('ar') + ' EGP';
            document.getElementById('totalOrders').textContent = totalOrders.toLocaleString('ar');
            document.getElementById('uniqueProducts').textContent = allProducts.size.toLocaleString('ar');
            document.getElementById('uniqueBrands').textContent = allBrands.size.toLocaleString('ar');
            document.getElementById('avgGMV').textContent = Math.round(totalGMV / totalCustomers).toLocaleString('ar') + ' EGP';
            document.getElementById('avgOrders').textContent = (totalOrders / totalCustomers).toFixed(1);
            document.getElementById('totalItems').textContent = totalItems.toLocaleString('ar');
            document.getElementById('totalAreas').textContent = Object.keys(groupedByArea).length.toLocaleString('ar');
            document.getElementById('totalCities').textContent = Object.keys(groupedByCity).length.toLocaleString('ar');
        }

        function renderAll() {
            renderCityGroupsTable();
            renderAreaGroupsTable();
            renderSegmentDistribution();
            renderCustomersTable();
        }

        // ========== RENDERING FUNCTIONS ==========
        function renderCityGroupsTable() {
            const tbody = document.getElementById('citiesTableBody');
            tbody.innerHTML = '';

            const cities = Object.values(groupedByCity).sort((a, b) => b.total_gmv - a.total_gmv);
            const start = (currentCityPage - 1) * citiesPerPage;
            const end = start + citiesPerPage;
            const pageData = cities.slice(start, end);

            pageData.forEach((city, idx) => {
                const globalIdx = start + idx;
                const row = document.createElement('tr');
                row.id = `city-row-${globalIdx}`;
                const avgGMV = Math.round(city.total_gmv / city.customer_count);
                row.innerHTML = `
                    <td>${city.city}</td>
                    <td>${city.customer_count}</td>
                    <td>${city.total_gmv.toLocaleString('ar')} EGP</td>
                    <td>${avgGMV.toLocaleString('ar')} EGP</td>
                    <td><button onclick="toggleCityDetails(${globalIdx})" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-family: 'Cairo', sans-serif;">Ø¹Ø±Ø¶</button></td>
                `;
                tbody.appendChild(row);

                // Create detail row (hidden by default)
                const detailRow = document.createElement('tr');
                detailRow.className = 'detail-row';
                detailRow.id = `city-detail-${globalIdx}`;
                detailRow.style.cssText = 'display: none; background: rgba(255, 255, 255, 0.02);';

                const customersList = city.customers
                    .sort((a, b) => b.total_gmv - a.total_gmv)
                    .slice(0, 50);

                const customersHtml = customersList.map(customer => `
                    <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                        <td style="padding: 12px 15px;">
                            <div style="color: #fafafa; font-weight: 600;">${customer.name}</div>
                            <div style="color: #71717a; font-size: 0.8rem; margin-top: 4px;">${customer.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</div>
                        </td>
                        <td style="padding: 12px 15px;">
                            <span style="display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; background: ${customer.segment_color}20; color: ${customer.segment_color};">â— ${customer.segment || 'N/A'}</span>
                        </td>
                        <td style="padding: 12px 15px; color: #fafafa; font-weight: 600;">${customer.total_gmv.toLocaleString('ar')} EGP</td>
                        <td style="padding: 12px 15px; color: #fafafa;">${customer.unique_orders || 0}</td>
                        <td style="padding: 12px 15px; color: #a1a1aa; font-size: 0.85rem;">${customer.type || 'N/A'}</td>
                    </tr>
                `).join('');

                detailRow.innerHTML = `
                    <td colspan="5" style="padding: 20px;">
                        <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 8px; overflow: hidden;">
                            <div style="padding: 15px; background: rgba(255, 255, 255, 0.02); border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <h4 style="color: #fafafa; font-weight: 600; font-size: 1rem; margin-bottom: 5px;">ğŸ‘¥ Ø¹Ù…Ù„Ø§Ø¡ ${city.city} (${city.customer_count} Ø¹Ù…ÙŠÙ„)</h4>
                                <p style="color: #a1a1aa; font-size: 0.85rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ GMV: ${city.total_gmv.toLocaleString('ar')} EGP | Ù…ØªÙˆØ³Ø· GMV: ${avgGMV.toLocaleString('ar')} EGP</p>
                            </div>
                            <div class="customers-table-container">
                                <table class="customers-table" style="margin: 0;">
                                    <thead>
                                        <tr>
                                            <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                            <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ GMV</th>
                                            <th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
                                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${customersHtml}
                                        ${city.customer_count > 50 ? `<tr><td colspan="5" style="text-align: center; padding: 15px; color: #a1a1aa; font-size: 0.85rem;">... Ùˆ ${city.customer_count - 50} Ø¹Ù…ÙŠÙ„ Ø¢Ø®Ø±</td></tr>` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(detailRow);
            });

            renderCitiesPagination();
        }

        function renderAreaGroupsTable() {
            const tbody = document.getElementById('areasTableBody');
            tbody.innerHTML = '';

            const areas = Object.values(groupedByArea).sort((a, b) => b.total_gmv - a.total_gmv);
            const start = (currentAreaPage - 1) * areasPerPage;
            const end = start + areasPerPage;
            const pageData = areas.slice(start, end);

            pageData.forEach((area, idx) => {
                const globalIdx = start + idx;
                const row = document.createElement('tr');
                row.id = `area-row-${globalIdx}`;
                const avgGMV = Math.round(area.total_gmv / area.customer_count);
                row.innerHTML = `
                    <td>${area.area}</td>
                    <td>${area.customer_count}</td>
                    <td>${area.total_gmv.toLocaleString('ar')} EGP</td>
                    <td>${avgGMV.toLocaleString('ar')} EGP</td>
                    <td><button onclick="toggleAreaDetails(${globalIdx})" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-family: 'Cairo', sans-serif;">Ø¹Ø±Ø¶</button></td>
                `;
                tbody.appendChild(row);

                // Create detail row (hidden by default)
                const detailRow = document.createElement('tr');
                detailRow.className = 'detail-row';
                detailRow.id = `area-detail-${globalIdx}`;
                detailRow.style.cssText = 'display: none; background: rgba(255, 255, 255, 0.02);';

                const customersList = area.customers
                    .sort((a, b) => b.total_gmv - a.total_gmv)
                    .slice(0, 50);

                const customersHtml = customersList.map(customer => `
                    <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                        <td style="padding: 12px 15px;">
                            <div style="color: #fafafa; font-weight: 600;">${customer.name}</div>
                            <div style="color: #71717a; font-size: 0.8rem; margin-top: 4px;">${customer.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</div>
                        </td>
                        <td style="padding: 12px 15px;">
                            <span style="display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; background: ${customer.segment_color}20; color: ${customer.segment_color};">â— ${customer.segment || 'N/A'}</span>
                        </td>
                        <td style="padding: 12px 15px; color: #fafafa; font-weight: 600;">${customer.total_gmv.toLocaleString('ar')} EGP</td>
                        <td style="padding: 12px 15px; color: #fafafa;">${customer.unique_orders || 0}</td>
                        <td style="padding: 12px 15px; color: #a1a1aa; font-size: 0.85rem;">${customer.type || 'N/A'}</td>
                    </tr>
                `).join('');

                detailRow.innerHTML = `
                    <td colspan="5" style="padding: 20px;">
                        <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 8px; overflow: hidden;">
                            <div style="padding: 15px; background: rgba(255, 255, 255, 0.02); border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <h4 style="color: #fafafa; font-weight: 600; font-size: 1rem; margin-bottom: 5px;">ğŸ‘¥ Ø¹Ù…Ù„Ø§Ø¡ ${area.area} (${area.customer_count} Ø¹Ù…ÙŠÙ„)</h4>
                                <p style="color: #a1a1aa; font-size: 0.85rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ GMV: ${area.total_gmv.toLocaleString('ar')} EGP | Ù…ØªÙˆØ³Ø· GMV: ${avgGMV.toLocaleString('ar')} EGP</p>
                            </div>
                            <div class="customers-table-container">
                                <table class="customers-table" style="margin: 0;">
                                    <thead>
                                        <tr>
                                            <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                            <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ GMV</th>
                                            <th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
                                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${customersHtml}
                                        ${area.customer_count > 50 ? `<tr><td colspan="5" style="text-align: center; padding: 15px; color: #a1a1aa; font-size: 0.85rem;">... Ùˆ ${area.customer_count - 50} Ø¹Ù…ÙŠÙ„ Ø¢Ø®Ø±</td></tr>` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(detailRow);
            });

            renderAreasPagination();
        }

        function renderSegmentDistribution() {
            const container = document.getElementById('segmentDistribution');
            container.innerHTML = '';

            Object.values(segments)
                .sort((a, b) => b.count - a.count)
                .forEach(segment => {
                    const percentage = (segment.count / customersData.length * 100).toFixed(1);
                    const card = document.createElement('div');
                    card.style.cssText = `
                        background: rgba(255, 255, 255, 0.03);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 12px;
                        padding: 20px;
                        transition: all 0.3s ease;
                    `;
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                <div style="width: 20px; height: 20px; background: ${segment.color}; border-radius: 4px;"></div>
                                <label style="color: #a1a1aa; font-size: 0.8rem; font-weight: 600;">${segment.name}</label>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #fafafa; font-weight: 700; font-size: 1.1rem;">${segment.count}</div>
                                <div style="color: #60a5fa; font-weight: 600; font-size: 0.85rem;">${percentage}%</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
        }

        function renderCustomersTable() {
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            pageData.forEach((customer, idx) => {
                const globalIdx = start + idx;
                const row = document.createElement('tr');
                row.id = `row-${globalIdx}`;
                
                row.innerHTML = `
                    <td>${customer.name}</td>
                    <td><span style="display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; background: ${customer.segment_color}20; color: ${customer.segment_color};">â— ${customer.segment || 'N/A'}</span></td>
                    <td>${customer.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</td>
                    <td>${customer.type || 'N/A'}</td>
                    <td>${customer.city}</td>
                    <td>${customer.area}</td>
                    <td>${customer.total_gmv.toLocaleString('ar')} EGP</td>
                    <td>${customer.unique_orders || 0}</td>
                    <td><button class="toggle-details" onclick="toggleDetails(${globalIdx})" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-family: 'Cairo', sans-serif;">Ø¹Ø±Ø¶</button></td>
                `;
                tbody.appendChild(row);

                // Create detail row (hidden by default)
                const detailRow = document.createElement('tr');
                detailRow.className = 'detail-row';
                detailRow.id = `detail-${globalIdx}`;
                detailRow.style.cssText = 'display: none; background: rgba(255, 255, 255, 0.02);';

                const productsArray = Object.entries(customer.products || {})
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 15);

                const brandsArray = Object.entries(customer.brands || {})
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 15);

                const ordersArray = (customer.orders || []).slice(0, 30);

                const productsHtml = productsArray
                    .map(([prod, count]) => `
                        <div style="background: rgba(255, 255, 255, 0.02); padding: 10px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.05); font-size: 0.8rem; margin-bottom: 8px;">
                            <div style="color: #fafafa; font-weight: 600; margin-bottom: 3px;">${prod}</div>
                            <div style="color: #60a5fa; font-size: 0.75rem;">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${count}</div>
                        </div>
                    `).join('');

                const brandsHtml = brandsArray
                    .map(([brand, count]) => `
                        <div style="background: rgba(255, 255, 255, 0.02); padding: 10px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.05); font-size: 0.8rem; margin-bottom: 8px;">
                            <div style="color: #fafafa; font-weight: 600; margin-bottom: 3px;">${brand}</div>
                            <div style="color: #4ade80; font-size: 0.75rem;">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${count}</div>
                        </div>
                    `).join('');

                const ordersHtml = ordersArray
                    .map((order, orderIdx) => `
                        <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 6px; margin-bottom: 15px; overflow: hidden;">
                            <div class="order-header" onclick="toggleOrder(${globalIdx}, ${orderIdx})" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(59, 130, 246, 0.1); cursor: pointer; border-left: 4px solid #60a5fa;">
                                <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                                    <span style="color: #71717a; font-size: 0.8rem; font-weight: 600;">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</span>
                                    <span style="color: #fafafa; font-weight: 700;">${order.order_id || 'N/A'}</span>
                                    <span style="color: #71717a; font-size: 0.8rem; font-weight: 600; margin-right: 20px;">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                                    <span style="color: #fafafa; font-weight: 700;">${order.date || 'N/A'}</span>
                                </div>
                                <div class="expand-arrow" id="arrow-${globalIdx}-${orderIdx}" style="color: #60a5fa; transition: transform 0.3s ease; font-size: 0.75rem;">â–¼</div>
                            </div>
                            <div class="order-items-container" id="items-${globalIdx}-${orderIdx}" style="display: none; padding: 15px; border-top: 1px solid rgba(255, 255, 255, 0.05); background: rgba(255, 255, 255, 0.01);">
                                ${(order.items || []).map(item => `
                                    <div style="background: rgba(255, 255, 255, 0.03); padding: 12px; border-radius: 6px; margin-bottom: 10px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; font-size: 0.85rem; border-left: 3px solid rgba(59, 130, 246, 0.5);">
                                        <div style="display: flex; flex-direction: column;">
                                            <div style="color: #71717a; font-size: 0.75rem; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px;">Ø§Ù„Ù…Ù†ØªØ¬</div>
                                            <div style="color: #fafafa; font-weight: 600;">${item.product || 'N/A'}</div>
                                        </div>
                                        <div style="display: flex; flex-direction: column;">
                                            <div style="color: #71717a; font-size: 0.75rem; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px;">Ø§Ù„Ø¹Ù„Ø§Ù…Ø©</div>
                                            <div style="color: #fafafa; font-weight: 600;">${item.brand || 'N/A'}</div>
                                        </div>
                                        <div style="display: flex; flex-direction: column;">
                                            <div style="color: #71717a; font-size: 0.75rem; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px;">Ø§Ù„ÙƒÙ…ÙŠØ©</div>
                                            <div style="color: #fafafa; font-weight: 600;">${item.quantity || 0}</div>
                                        </div>
                                        <div style="display: flex; flex-direction: column;">
                                            <div style="color: #71717a; font-size: 0.75rem; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px;">Ø§Ù„Ø³Ø¹Ø±</div>
                                            <div style="color: #fafafa; font-weight: 600;">${item.price || 0} EGP</div>
                                        </div>
                                        <div style="display: flex; flex-direction: column;">
                                            <div style="color: #71717a; font-size: 0.75rem; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                                            <div style="color: #fafafa; font-weight: 600;">${(item.total || 0).toLocaleString('ar')} EGP</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('');

                detailRow.innerHTML = `
                    <td colspan="9" style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div style="background: rgba(255, 255, 255, 0.03); padding: 15px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.05);">
                                <h4 style="color: #a1a1aa; font-size: 0.85rem; margin-bottom: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h4>
                                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.02);">
                                    <label style="color: #71717a; font-size: 0.85rem;">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                                    <span style="color: #fafafa; font-weight: 600;">${customer.name}</span>
                                </div>
                                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.02);">
                                    <label style="color: #71717a; font-size: 0.85rem;">Ø§Ù„ØªØµÙ†ÙŠÙ:</label>
                                    <span style="color: ${customer.segment_color}; font-weight: 600;">â— ${customer.segment || 'N/A'}</span>
                                </div>
                                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.02);">
                                    <label style="color: #71717a; font-size: 0.85rem;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
                                    <span style="color: #fafafa; font-weight: 600;">${customer.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span>
                                </div>
                                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.02);">
                                    <label style="color: #71717a; font-size: 0.85rem;">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
                                    <span style="color: #fafafa; font-weight: 600;">${customer.city}</span>
                                </div>
                                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.02);">
                                    <label style="color: #71717a; font-size: 0.85rem;">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label>
                                    <span style="color: #fafafa; font-weight: 600;">${customer.area}</span>
                                </div>
                                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.02);">
                                    <label style="color: #71717a; font-size: 0.85rem;">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                                    <span style="color: #fafafa; font-weight: 600;">${customer.type || 'N/A'}</span>
                                </div>
                            </div>

                            <div style="background: rgba(255, 255, 255, 0.03); padding: 15px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.05);">
                                <h4 style="color: #a1a1aa; font-size: 0.85rem; margin-bottom: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">ğŸ’° Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h4>
                                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.02);">
                                    <label style="color: #71717a; font-size: 0.85rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ GMV:</label>
                                    <span style="color: #fafafa; font-weight: 600;">${customer.total_gmv.toLocaleString('ar')} EGP</span>
                                </div>
                                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.02);">
                                    <label style="color: #71717a; font-size: 0.85rem;">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</label>
                                    <span style="color: #fafafa; font-weight: 600;">${customer.unique_orders || 0}</span>
                                </div>
                                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.02);">
                                    <label style="color: #71717a; font-size: 0.85rem;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</label>
                                    <span style="color: #fafafa; font-weight: 600;">${customer.item_count || 0}</span>
                                </div>
                                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.02);">
                                    <label style="color: #71717a; font-size: 0.85rem;">Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨:</label>
                                    <span style="color: #fafafa; font-weight: 600;">${Math.round(customer.avg_order_value || 0).toLocaleString('ar')} EGP</span>
                                </div>
                                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.02);">
                                    <label style="color: #71717a; font-size: 0.85rem;">Ù…Ù†ØªØ¬Ø§Øª ÙØ±ÙŠØ¯Ø©:</label>
                                    <span style="color: #fafafa; font-weight: 600;">${customer.unique_products || 0}</span>
                                </div>
                                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.02);">
                                    <label style="color: #71717a; font-size: 0.85rem;">Ø¹Ù„Ø§Ù…Ø§Øª ØªØ¬Ø§Ø±ÙŠØ©:</label>
                                    <span style="color: #fafafa; font-weight: 600;">${customer.unique_brands || 0}</span>
                                </div>
                            </div>
                        </div>

                        <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 8px; margin-top: 20px; overflow: hidden;">
                            <div class="section-header" onclick="toggleSection(this)" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; cursor: pointer; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.02);">
                                <span style="color: #fafafa; font-weight: 600; font-size: 0.95rem;">ğŸ›ï¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${productsArray.length})</span>
                                <span class="section-toggle" style="color: #60a5fa; transition: transform 0.3s ease; font-size: 0.8rem;">â–¶</span>
                            </div>
                            <div class="section-content" style="padding: 15px; border-top: 1px solid rgba(255, 255, 255, 0.05); display: none;">
                                ${productsHtml}
                            </div>
                        </div>

                        <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 8px; margin-top: 20px; overflow: hidden;">
                            <div class="section-header" onclick="toggleSection(this)" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; cursor: pointer; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.02);">
                                <span style="color: #fafafa; font-weight: 600; font-size: 0.95rem;">ğŸ·ï¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© (${brandsArray.length})</span>
                                <span class="section-toggle" style="color: #60a5fa; transition: transform 0.3s ease; font-size: 0.8rem;">â–¶</span>
                            </div>
                            <div class="section-content" style="padding: 15px; border-top: 1px solid rgba(255, 255, 255, 0.05); display: none;">
                                ${brandsHtml}
                            </div>
                        </div>

                        <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 8px; margin-top: 20px; overflow: hidden;">
                            <div class="section-header" onclick="toggleSection(this)" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; cursor: pointer; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.02);">
                                <span style="color: #fafafa; font-weight: 600; font-size: 0.95rem;">ğŸ“¦ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (${customer.unique_orders || 0} Ø·Ù„Ø¨)</span>
                                <span class="section-toggle" style="color: #60a5fa; transition: transform 0.3s ease; font-size: 0.8rem;">â–¶</span>
                            </div>
                            <div class="section-content" style="padding: 15px; border-top: 1px solid rgba(255, 255, 255, 0.05); display: none;">
                                ${ordersHtml}
                                ${customer.unique_orders > 30 ? `<div style="color: #a1a1aa; margin-top: 15px; font-size: 0.85rem;">... Ùˆ ${customer.unique_orders - 30} Ø·Ù„Ø¨ Ø¢Ø®Ø±</div>` : ''}
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(detailRow);
            });

            renderPagination();
        }

        function renderPagination() {
            const container = document.getElementById('paginationContainer');
            container.innerHTML = '';
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const start = (currentPage - 1) * itemsPerPage + 1;
            const end = Math.min(currentPage * itemsPerPage, filteredData.length);

            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'â† Ø§Ù„Ø³Ø§Ø¨Ù‚';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; renderCustomersTable(); } };
            prevBtn.style.cssText = 'background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-family: Cairo, sans-serif; transition: all 0.3s ease;';
            container.appendChild(prevBtn);

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Ø§Ù„ØµÙØ­Ø© ${currentPage} Ù…Ù† ${totalPages} | Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ${start}-${end} Ù…Ù† ${filteredData.length}`;
            pageInfo.style.cssText = 'color: #a1a1aa; font-size: 0.9rem; padding: 8px 12px; font-weight: 500;';
            container.appendChild(pageInfo);

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Ø§Ù„ØªØ§Ù„ÙŠ â†’';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { if (currentPage < totalPages) { currentPage++; renderCustomersTable(); } };
            nextBtn.style.cssText = 'background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-family: Cairo, sans-serif; transition: all 0.3s ease;';
            container.appendChild(nextBtn);
        }

        function renderCitiesPagination() {
            const container = document.getElementById('citiesPaginationContainer');
            container.innerHTML = '';
            const cities = Object.values(groupedByCity);
            const totalPages = Math.ceil(cities.length / citiesPerPage);

            if (totalPages <= 1) return;

            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'â† Ø§Ù„Ø³Ø§Ø¨Ù‚';
            prevBtn.disabled = currentCityPage === 1;
            prevBtn.onclick = () => { if (currentCityPage > 1) { currentCityPage--; renderCityGroupsTable(); } };
            prevBtn.style.cssText = 'background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-family: Cairo, sans-serif; transition: all 0.3s ease;';
            if (prevBtn.disabled) prevBtn.style.opacity = '0.5';
            container.appendChild(prevBtn);

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Ø§Ù„ØµÙØ­Ø© ${currentCityPage} Ù…Ù† ${totalPages}`;
            pageInfo.style.cssText = 'color: #a1a1aa; font-size: 0.9rem; padding: 8px 12px;';
            container.appendChild(pageInfo);

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Ø§Ù„ØªØ§Ù„ÙŠ â†’';
            nextBtn.disabled = currentCityPage === totalPages;
            nextBtn.onclick = () => { if (currentCityPage < totalPages) { currentCityPage++; renderCityGroupsTable(); } };
            nextBtn.style.cssText = 'background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-family: Cairo, sans-serif; transition: all 0.3s ease;';
            if (nextBtn.disabled) nextBtn.style.opacity = '0.5';
            container.appendChild(nextBtn);
        }

        function renderAreasPagination() {
            const container = document.getElementById('areasPaginationContainer');
            container.innerHTML = '';
            const areas = Object.values(groupedByArea);
            const totalPages = Math.ceil(areas.length / areasPerPage);

            if (totalPages <= 1) return;

            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'â† Ø§Ù„Ø³Ø§Ø¨Ù‚';
            prevBtn.disabled = currentAreaPage === 1;
            prevBtn.onclick = () => { if (currentAreaPage > 1) { currentAreaPage--; renderAreaGroupsTable(); } };
            prevBtn.style.cssText = 'background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-family: Cairo, sans-serif; transition: all 0.3s ease;';
            if (prevBtn.disabled) prevBtn.style.opacity = '0.5';
            container.appendChild(prevBtn);

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Ø§Ù„ØµÙØ­Ø© ${currentAreaPage} Ù…Ù† ${totalPages}`;
            pageInfo.style.cssText = 'color: #a1a1aa; font-size: 0.9rem; padding: 8px 12px;';
            container.appendChild(pageInfo);

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Ø§Ù„ØªØ§Ù„ÙŠ â†’';
            nextBtn.disabled = currentAreaPage === totalPages;
            nextBtn.onclick = () => { if (currentAreaPage < totalPages) { currentAreaPage++; renderAreaGroupsTable(); } };
            nextBtn.style.cssText = 'background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-family: Cairo, sans-serif; transition: all 0.3s ease;';
            if (nextBtn.disabled) nextBtn.style.opacity = '0.5';
            container.appendChild(nextBtn);
        }

        // ========== UTILITY FUNCTIONS ==========
        function toggleDetails(idx) {
            const detailRow = document.getElementById(`detail-${idx}`);
            if (detailRow) {
                detailRow.style.display = detailRow.style.display === 'none' ? 'table-row' : 'none';
            }
        }

        function toggleCityDetails(idx) {
            const detailRow = document.getElementById(`city-detail-${idx}`);
            if (detailRow) {
                detailRow.style.display = detailRow.style.display === 'none' ? 'table-row' : 'none';
            }
        }

        function toggleAreaDetails(idx) {
            const detailRow = document.getElementById(`area-detail-${idx}`);
            if (detailRow) {
                detailRow.style.display = detailRow.style.display === 'none' ? 'table-row' : 'none';
            }
        }

        function toggleOrder(customerIdx, orderIdx) {
            const container = document.getElementById(`items-${customerIdx}-${orderIdx}`);
            const arrow = document.getElementById(`arrow-${customerIdx}-${orderIdx}`);
            if (container) {
                container.style.display = container.style.display === 'none' ? 'block' : 'none';
                if (arrow) {
                    arrow.style.transform = container.style.display === 'none' ? 'rotate(0deg)' : 'rotate(180deg)';
                }
            }
        }

        function toggleSection(element) {
            const section = element.closest('div[style*="border-radius"]');
            const content = section.querySelector('.section-content');
            const toggle = section.querySelector('.section-toggle');
            if (content && toggle) {
                content.style.display = content.style.display === 'none' ? 'block' : 'none';
                toggle.style.transform = content.style.display === 'none' ? 'rotate(0deg)' : 'rotate(90deg)';
            }
        }

        // ========== SEARCH FUNCTIONALITY ==========
        document.getElementById('customerSearch').addEventListener('keyup', function(e) {
            const value = e.target.value.toLowerCase();
            filteredData = customersData.filter(customer =>
                customer.name.toLowerCase().includes(value) ||
                (customer.phone && customer.phone.toString().toLowerCase().includes(value)) ||
                customer.city.toLowerCase().includes(value) ||
                customer.area.toLowerCase().includes(value)
            );
            currentPage = 1;
            renderCustomersTable();
        });

        // ========== PAGE LOAD ==========
        initialize();
    </script>
</body>
</html>


